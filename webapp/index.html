<!--
  Copyright 2016 LinkedIn Corp. Licensed under the Apache License, Version 2.0 (the "License"); you may not use this
  file except in compliance with the License. You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
  an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-->

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>JS Bin</title>
  <script type="text/javascript" src="/js/Chart.js"></script>
  <script type="text/javascript" src="/js/json2.js"></script>
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
  <script type="text/javascript" src="/js/jolokia-min.js"></script>
  <script type="text/javascript" src="/js/jolokia-simple-min.js"></script>
</head>

<body>
  <h1 style="text-align:center">Kafka Monitor GUI</h1>

  <div style="margin-left:30px">
    <table id="table" width="100%"> </table>
  </div>

</body>

<style type="text/css">

text {
  font-family: "Times New Roman";
  font-size: 20px;
  text-align: center;
}

</style>


<script>

  function createCanvas(name, cells) {
    var div = document.createElement("div");
    div.align = "center";
    div.style.width = document.body.clientWidth/2 + "px";
    div.style.height = "300px";
    div.style.display = "table-cell";

    if (cells.length == 0) {
      var row = document.getElementById("table").insertRow(-1);
      cells.push(row.insertCell(-1));
      cells.push(row.insertCell(-1));
    }

    cells[0].appendChild(div);
    cells.shift();

    var canvas = document.createElement('canvas');
    canvas.id = name;
    canvas.width  = div.offsetWidth;
    canvas.height = div.offsetHeight * 0.9;
    div.appendChild(canvas);

    var br = document.createElement('br');
    div.appendChild(br);

    var svg = document.createElement('svg');
    svg.style.fontSize = "20px";
    svg.width = div.width;
    svg.height = div.height * 0.1;
    div.appendChild(svg);

    var text = document.createTextNode(name);
    text.x = svg.width / 2;
    text.y = svg.height / 2;
    text.fill = "Black";
    svg.appendChild(text);

    return canvas
  }

  function getDefaultLine() {
    var startingLabel = [];
    var startingData = [];
    for (var i = 0; i < dataNum; i++) {
      startingLabel.push("");
      startingData.push(0);
    }

    return {
      labels: startingLabel,
      datasets: [{
        fillColor: "rgba(220,220,220,0.2)",
        strokeColor: "rgba(220,220,220,1)",
        pointColor: "rgba(220,220,220,1)",
        pointStrokeColor: "#fff",
        data: startingData}]
    }
  }

  function createCharts(mbeans) {
    var charts = {};
    var cells = [];

    $(mbeans).each(function (idx, mbean) {
      var canvas = createCanvas(mbean.attribute, cells);
      var ctx = document.getElementById(mbean.attribute).getContext('2d');
      var chart = new Chart(ctx).Line(getDefaultLine(), {animationSteps: 60});
      charts[mbean.attribute] = chart;
    });
    return charts;
  }

  function pollAndUpdateCharts(mbeans, charts) {
    var requests = $.map(mbeans, function (mbean) {
      return {
        type: "read",
        mbean: mbean.name,
        attribute: mbean.attribute
      };
    });

    var responses = j4p.request(requests);
    $(responses).each(function (idx, response) {
      var label = response.timestamp - beginTime;
      var attribute = response.request.attribute;

      $.each(response.value, function (mbean, values) {
        if (label % 5 != 0)
          label = "";
        charts[attribute].addData([values[attribute]], label);
        charts[attribute].removeData();
      });
    });
  }

  var beginTime = Math.round(new Date().getTime() / 1000);
  var dataNum = 30;
  var pollIntervalMs = 1000;
  var monitoredMbeans = [
    {name: "kmf.services:type=produce-metrics,name=*", attribute: "produce-availability-avg"},
    {name: "kmf.services:type=produce-metrics,name=*", attribute: "records-produced-rate"},
    {name: "kmf.services:type=consume-metrics,name=*", attribute: "records-lost-rate"},
    {name: "kmf.services:type=consume-metrics,name=*", attribute: "records-duplicated-rate"},
    {name: "kmf.services:type=consume-metrics,name=*", attribute: "records-delay-ms-avg"},
    {name: "kmf.services:type=consume-metrics,name=*", attribute: "records-delay-ms-99th"},
    {name: "kmf.services:type=consume-metrics,name=*", attribute: "records-delay-ms-999th"},
    {name: "kmf.services:type=consume-metrics,name=*", attribute: "records-delay-ms-max"},
  ];

  var ip = location.host.split(':')[0];
  var j4p = new Jolokia({url: "http://" + ip + ":8778/jolokia"});
  var monitoredCharts = createCharts(monitoredMbeans);

  setInterval(function () {
    pollAndUpdateCharts(monitoredMbeans, monitoredCharts);
  }, pollIntervalMs);

</script>


</html>
